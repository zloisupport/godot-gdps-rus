# Часть 3 Главная сцена

Главная сцена - это то, что объединяет все части игры. Она будет управлять игроком, монетами, часами и всеми остальными элементами игры.

## Настройка узлов
Создайте новую сцену и добавьте узел с именем Main. Простейший тип узла - это Node. Сам по себе он не делает ничего особенного, но вы будете использовать его в качестве родительского для всех игровых объектов и добавите скрипт, который предоставит ему необходимую функциональность. Сохраните сцену.
Добавьте игрока в качестве дочернего элемента Main, нажав кнопку "Instantiate Child Scene" и выбрав сохраненный файл player.tscn:

![Создавая сцену](/img/1-coin/23.png)

Добавьте следующие узлы в качестве дочерних элементов Main:

::list
    - Узел TextureRect с именем Background - для изображения заднего фона
    - Узел Timer с именем GameTimer - для отсчета времени
::list

Убедитесь, что Background - это первый дочерний узел, перетащив его выше игрока в списке узлов. Узлы отрисовываются в порядке, показанном в дереве, поэтому, если Background первый, это гарантирует, что он рисуется за игроком. Добавьте изображение в узел Background, перетащив изображение grass.png из папки assets в свойство Texture. Измените режим растяжения (Stretch Mode) на Tile, а затем установите размер в Full Rect, нажав кнопку layout в верхней части окна редактора:

![Параметры макета](/img/1-coin/24.png)

## Главный сценарий
Добавьте сценарий к узлу Main и добавьте следующие переменные:

::
    extends Node
    @export var coin_scene : PackedScene
    @export var playtime = 30
    var level = 1
    var score = 0
    var time_left = 0
    var screensize = Vector2.ZERO
    var playing = false 
::


Теперь свойства Coin Scene и Playtime появляются в окне Inspector при выборе узла Main.
Перетащите coin.tscn из панели FileSystem и бросьте его в свойство Coin Scene.

Инициализация
Для начала добавьте функцию `_ready()`:
::
    func _ready():
        screensize = get_viewport().get_visible_rect().size
        $Player.screensize = screensize
        $Player.hide() 
::

Godot автоматически вызывает `_ready()` для каждого узла при его добавлении. Это хорошее место для размещения кода, который вы хотите выполнить в начале жизненного цикла узла.
Обратите внимание, что вы обращаетесь к узлу Player по имени, используя синтаксис $, что позволяет вам определить размер экрана игры и установить переменную screensize для игрока. hide() делает узел невидимым, поэтому вы не увидите игрока до начала игры.

## Начало новой игры
Функция new_game() будет инициализировать все для новой игры:

::
    func new_game():
        playing = true
        level = 1
        score = 0
        time_left = playtime
        $Player.start()
        $Player.show()
        $GameTimer.start()
        spawn_coins() 

::

В дополнение к установке переменных на их начальные значения, эта функция вызывает ранее написанную вами функцию start() игрока. Запуск GameTimer начнет отсчет оставшегося времени в игре. Вам также нужна функция, которая будет создавать определенное количество монет в зависимости от текущего уровня:

::
    func spawn_coins():
        for i in level + 4:
            var c = coin_scene.instantiate()
            add_child(c)
            c.screensize = screensizec.position = Vector2(randi_range(0, screensize.x),
                randi_range(0, screensize.y)) 

::



В этой функции вы создаете несколько экземпляров(instances) объекта Coin и добавляете их в качестве дочерних элементов Main (на этот раз в коде, а не вручную, щелкая по кнопке "Создать дочернюю сцену"( Instantiate Child Scene)). Всегда, когда вы создаете новый узел, его нужно добавлять в дерево сцены с помощью add_child(). Наконец, вы выбираете случайное положение для монеты, используя переменную screensize, чтобы они не появлялись за пределами экрана. Вы будете вызывать эту функцию в начале каждого уровня, генерируя больше монет каждый раз.

В конечном итоге, вы захотите, чтобы `new_game()` вызывалась, когда игрок нажимает кнопку "start" в меню. Теперь, чтобы проверить, что все работает, добавьте `new_game()` в конец вашей функции `_ready()` и нажмите **"Run Project" (F5)**. Когда вас попросят выбрать основную сцену, выберите main.tscn. Теперь, когда вы играете в проект, сцена Main будет запущена.

На этом этапе вы должны видеть своего игрока и пять монет на экране. Когда игрок касается монеты, она исчезает.

Когда тестирование будет завершено, удалите `new_game()` из функции `_ready()`.

## Проверка наличия оставшихся монет

Код в функции _process() следит за тем, сколько монет осталось в группе "coins". Каждый кадр он проверяет размер группы и, если она становится равной 0, то есть все монеты были подобраны, вызывается функция next_level(), которая вам нужно будет реализовать.

Таким образом, когда все монеты будут подобраны, игра перейдет на следующий уровень. Вы можете использовать этот момент для обновления игровых элементов, увеличения сложности или выполнения других действий, связанных с переходом на следующий уровень.
::
    func _process(delta):
        if playing and
            get_tree().get_nodes_in_group("coins").size() == 0:
                level += 1
                time_left += 5
                spawn_coins() 
::

В данном шаге вы научились создавать новые объекты в коде с использованием функции `instantiate()`. Это важный навык, который вы будете применять многократно при создании различных игровых систем. В последнем шаге вы создадите еще одну сцену для отображения информации об игре, такой как счет игрока и оставшееся время.