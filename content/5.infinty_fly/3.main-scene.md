# Основная сцена [Main scene]

В этом разделе вы создадите основную сцену, которая в этой игре будет отвечать за загрузку чанков мира, отображение игровой информации, а также запуск и завершение игры.

Начните новую сцену с узлом **Node3D** под названием **Main**. Для начала добавьте экземпляр Plane и экземпляр **Chunk**.

Для освещения на панели инструментов выберите раскрывающийся список Edit Sun and Environment settings (Редактировать настройки солнца и среды) и добавьте солнце и окружение в сцену.


![Добавить окружение и солнце](/img/infinity-fly/6.10.jpg)
Рисунок 6.10: Добавить окружение и солнце

Вместо использования сгенерированной текстуры неба, вы можете использовать styled_sky.hdr, найденный в папке assets. Выберите WorldEnvironment, а затем разверните его свойство Sky. Вы увидите, что оно установлено на ProdeduralSkyMaterial. Щелкните стрелку вниз и выберите New PanoramaSkyMaterial. Развернув его, вы увидите пустое свойство Panorama, куда можно перетащить styled_sky.hdr:

![Параметры неба WorldEnvironment](/img/infinity-fly/6.11.jpg)

Рисунок 6.11: Параметры неба WorldEnvironment

Прежде чем приступить к тестированию, вам также понадобится камера. Добавьте **Camera3D**, а затем добавьте к ней скрипт. Поскольку это одиночный узел без дочерних элементов, вам не нужно его сохранять как отдельную сцену.

```gdscript
extends Camera3D
@export var target_path : NodePath
@export var offset = Vector3.ZERO
var target = null
func _ready():
    if target_path:
        target = get_node(target_path)
        position = target.position + offset
        look_at(target.position)
func _physics_process(_delta):
    if !target:
        return
    position = target.position + offset

```

Этот скрипт камеры универсален и может использоваться в других проектах, где вы хотите, чтобы камера следовала за движущимся 3D-объектом. Выберите узел Camera3D и в инспекторе нажмите Target Path и выберите узел Plane. Установите Offset на (7, 7, 15), чтобы камера находилась позади, выше и справа от плоскости.

![Параметры слежения камеры](/img/infinity-fly/6.12.jpg)

Рисунок 6.12: Параметры слежения камеры

Запустите сцену Main, и вы сможете лететь по чанку, собирая кольца. Если вы столкнетесь со зданиями, ничего не произойдет, а когда вы достигнете конца чанка, вы не увидите другого.

## Появление новых чанков

Длина каждого чанка составляет 200 единиц, поэтому, когда плоскость прошла половину этого расстояния, новый чанк должен появиться впереди в конечной позиции предыдущего чанка. Параметр max_position будет отслеживать середину следующего чанка впереди, то есть позицию, которую должна достичь плоскость, чтобы создать новый чанк.

Вы также будете следить за тем, сколько чанков было создано, чтобы определить, когда игра должна стать сложнее.

Добавьте скрипт к Main и добавьте следующее: 

```gdscript
extends Node3D
var chunk = preload("res://chunk.tscn")
var num_chunks = 1
var chunk_size = 200
var max_position = -100
```
Имейте в виду, что все движется вперед в направлении -z, поэтому позиция по центру первого чанка будет иметь значение z равное -100. Координата z плоскости будет продолжать уменьшаться по мере ее движения вперед.

В функции `_process()` вы будете проверять позицию плоскости [plane], и если она пройдет мимо max_position, значит, пора создать экземпляр нового чанка и обновить max_position до центра следующего чанка.

```gdscript
func _process(delta):
    if $Plane.position.z  < max_position:
        num_chunks += 1
        var new_chunk = chunk.instantiate()
        new_chunk.position.z = max_position – chunk_size / 2
        new_chunk.level = num_chunks / 4
        add_child(new_chunk)
        max_position -= chunk_size
```

Вот где происходит появление новых чанков. Новый чанк размещается в конце предыдущего. Помните, что max_position - это центр чанка, поэтому вам также нужно добавить chunk_size / 2.

Затем, чтобы получить номер уровня, деление на 4 приводит к целочисленному делению, то есть дробная часть будет отброшена. Например, для чанка номер 5, 5/4 равно просто 1. Уровень достигнет 2 на чанке номер 8, 3 на чанке номер 12 и так далее. Это обеспечит постепенное повышение сложности.

Запустите сцену. Теперь вы должны увидеть новые чанки, появляющиеся перед плоскостью по мере ее движения вперед.

## Растущая сложность

Теперь, когда вы создаете чанки, им присваивается значение уровня, которое постепенно увеличивается. Вы можете использовать это, чтобы сделать кольца более сложными для сбора. Например, на данный момент они расположены точно по центру, поэтому игроку вообще не нужно рулить влево или вправо. Вы можете начать рандомизировать координату x колец. Вы также можете заставить кольца двигаться вперед-назад или вверх-вниз.

Добавьте эти переменные в начало ring.gd: 
```gdscript
var move_x = false
var move_y = false
var move_amount = 2.5
var move_speed = 2.0
```

Эти две булевы переменные позволят вам включать движение в направлении x или y, а `move_amount` и move_speed позволят вам контролировать, насколько сильным будет движение.

Когда эти значения установлены, вы можете проверить `_ready()`, начать движение, а затем использовать твин [tween]:


```gdscript
func _ready():
    $Label3D.hide()
    var tween = create_tween().set_loops().set_trans(Tween.TRANS_SINE)
    tween.stop()
    if move_y:
        tween.tween_property($CollisionShape3D,"position:y", -move_amount, move_speed)
        tween.tween_property($CollisionShape3D, "position:y", move_amount, move_speed) 
        tween.play()
    if move_x:
        tween.tween_property($CollisionShape3D,position:x", -move_amount, move_speed)
        tween.tween_property($CollisionShape3D, "position:x", move_amount, move_speed)
        tween.play()
```


Имейте в виду, что по умолчанию твин начинает воспроизводиться автоматически. Поскольку вам может понадобиться анимировать свойство или нет, в зависимости от того, на каком уровне находится игрок, вы можете использовать `stop()` для первоначальной остановки твина, а затем использовать `play()` для его запуска, как только вы определите, какое свойство вы хотите  изменить. Используя `set_loops()`, вы указываете твину бесконечно повторять два движения, перемещаясь вперед и назад.

Теперь, когда кольцо готово к движению, ваш чанк может установить эти значения при его появлении. Перейдите в `chunk.gd` и обновите раздел, который создает кольца, чтобы использовать уровень [level]:

```
func add_rings():
    for z in range(0, -200, -10):
        var n = randf()
        if n > 0.76:
            var nr = ring.instantiate()
            nr.position.z = z
            nr.position.y = randf_range(3, 17)
            match level:
                0: pass
                1: nr.move_y = true
                2: nr.position.x = randf_range(-10, 10) nr.move_y = true
                3: nr.position.x = randf_range(-10, 10)
                    nr.move_x = true add_child(nr)
            add_child(nr)
```

Как видите, как только уровень достигнет 1, кольца начнут двигаться вверх и вниз. На уровне 2 они начнут иметь случайную позицию x, а на уровне 3 они начнут двигаться горизонтально.

Это всего лишь пример того, что возможно. Не стесняйтесь создавать свой собственный шаблон для повышения сложности.