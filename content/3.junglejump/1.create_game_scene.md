# Создание сцены игрока

Узел Godot, реализующий кинематическое движение и столкновение, называется CharacterBody2D. Откройте новую сцену и добавьте узел CharacterBody2D с именем Player в качестве корневого и сохраните сцену. Не забудьте нажать кнопку "Group Selected Node(s)". При сохранении сцены Player вы также должны создать новую папку для её содержимого. Это поможет поддерживать порядок в папке проекта по мере добавления новых сцен и скриптов.

Ознакомьтесь со свойствами CharacterBody2D в инспекторе. Обратите внимание на значения по умолчанию для режима движения (Motion Mode) и направления вверх (Up Direction). Режим "Grounded" означает, что тело будет рассматривать одно направление столкновения как "пол", противоположную стену как "потолок", а любые другие как "стены" – какое именно определяется направлением вверх (Up Direction).

Как и в предыдущих проектах, вы включите все узлы, необходимые для функционирования персонажа-игрока, в сцену Player. Для этой игры это означает обработку столкновений с различными игровыми объектами, такими как платформы, враги и предметы для сбора; отображение анимаций для действий, таких как бег или прыжок; и прикрепление камеры для слежения за игроком по уровню.

Сценарии для различных анимаций могут быстро стать неуправляемыми, поэтому вам нужно будет использовать конечный автомат (FSM) для управления и отслеживания состояний игрока. Ознакомьтесь с главой 3, чтобы вспомнить, как можно создать упрощенный FSM. Вы будете следовать подобному паттерну и для этого проекта.

## Слои столкновений и маски

Свойство Collision/Layer тела определяет на каком (на каких) слое(ах) в физическом мире находится тело. Игроку необходимо быть присвоенным слою "player" (который вы назвали в настройках проекта). Точно так же, свойство Collision/Mask определяет, с какими слоями тело может "видеть" или взаимодействовать. Если объект находится на слое, отсутствующем в маске игрока, то игрок не взаимодействует с ним вообще.
Установите слой игрока на "player" и маску на "environment", "enemies" и "items". Нажмите на три точки справа, чтобы открыть список флажков, отображающих имена, которые вы присвоили слоям:

![Свойство Collision/Layer](/img/jungle-jump/4.jpg)
Это гарантирует, что игрок находится на слое "player", что позволяет настраивать другие объекты на обнаружение или игнорирование игрока. Установка значения маски для всех трех слоев означает, что игрок сможет взаимодействовать с объектами на любом из этих слоев.

## О AnimationPlayer
Ранее в этой книге вы использовали AnimatedSprite2D для отображения анимаций на основе кадров ваших персонажей. Это отличный инструмент, но он полезен только для анимации визуальной текстуры узла. Что если вы также хотите анимировать любые другие свойства узла?

В этом случае пригодится AnimationPlayer. Этот узел является очень мощным инструментом для создания анимаций, которые могут влиять на несколько узлов одновременно; вы можете изменять любые из их свойств.

## Animations
Для настройки анимаций персонажа выполните следующие шаги:

Добавьте узел Sprite2D к узлу Player. Перетащите файл res://assets/player_sheet.png из панели FileSystem и отпустите его в свойство Texture. Анимация игрока будет сохранена в виде спрайт-листа:

![Спрайт-лист](/img/jungle-jump/B19289_04_05.jpg)

Вы будете использовать AnimationPlayer для управления анимациями. В свойствах анимации узла Sprite2D установите HFrames равным 19. Затем установите Frame равным 7, чтобы увидеть стоящего игрока. Наконец, поднимите Sprite2D вверх, пока его ноги не будут стоять на земле, установив свойство Position равным (0, -16). Это упростит написание кода для взаимодействия с игроком, так как вы будете знать, что свойство позиции игрока представляет собой местоположение его ног.

Добавьте узел AnimationPlayer в сцену. Вы будете использовать этот узел для изменения свойства Frame узла Sprite2D на соответствующие значения для каждой анимации. Прежде чем начать, ознакомьтесь с различными частями панели анимации:

![Панель анимации](/img/jungle-jump/B19289_04_06.jpg)


Нажмите кнопку Animation и выберите New. Назовите новую анимацию idle.
Установите ее продолжительность равной 0,4 секунды. Нажмите на иконку Loop, чтобы сделать анимацию цикличной, и установите режим обновления трека в Continuous.
Измените свойство Frame узла Sprite2D на 7, что является первым кадром анимации покоя, и щелкните на иконку ключевого кадра рядом со свойством, чтобы добавить трек анимации с новым ключевым кадром:

![Добавление ключевого кадра](/img/jungle-jump/B19289_04_07.jpg)

Переместите ползунок воспроизведения на 0,3 (вы можете отрегулировать регулятор масштаба в правом нижнем углу, чтобы упростить поиск). Добавьте ключевой кадр для кадра 10, который является последним кадром покоя.
Нажмите кнопку Play, чтобы посмотреть анимацию. Если она выглядит неправильно, вернитесь к предыдущему пункту и убедитесь, что вы точно следовали всем шагам, особенно тому факту, что начинаете с кадра 7 и заканчиваете на кадре 10.
Теперь повторите этот процесс для других анимаций. Смотрите таблицу ниже для списка их настроек:

| Имя       | Продолжительность | Кадры        | Цикличность |
|-----------|-------------------|--------------|-------------|
| idle      | 0.4 сек           | 7 → 10       | Вкл         |
| run       | 0.5 сек           | 13 → 18      | Вкл         |
| hurt      | 0.2 сек           | 5 → 6        | Вкл         |
| jump_up   | 0.1 сек           | 11           | Выкл        |
| jump_down | 0.1 сек           | 12           | Выкл        |

Также есть анимации для приседания и лазания в спрайт-листе, но вы можете добавить их позже, когда базовое движение будет завершено.

## Collision shape

Как и с другими телами, CharacterBody2D требуется форма, назначенная для определения его границ столкновения. Добавьте узел CollisionShape2D и создайте внутри него новую форму RectangleShape2D. При размерировании формы вы хотите, чтобы она достигала до нижней части изображения (ноги игрока), но была немного уже, чем изображение самого игрока. В целом, сделать форму немного меньше, чем изображение, приведет к лучшему ощущению во время игры, избегая впечатления о столкновении с чем-то, что, казалось бы, не должно вызывать столкновение.

Вам также нужно сместить форму немного, чтобы она подходила. Установка свойства Position узла CollisionShape2D в (0, -10) хорошо подходит. Когда вы закончите, это должно выглядеть примерно так:

![Форма столкновения игрока](/img/jungle-jump/B19289_04_08.jpg)

## Несколько форм

В некоторых случаях, в зависимости от сложности вашего персонажа и его взаимодействий с другими объектами, вы можете захотеть добавить несколько форм к одному и тому же объекту. Вы можете иметь одну форму у ног игрока для обнаружения столкновений с землей, другую на его теле для обнаружения урона и еще одну, покрывающую переднюю часть игрока для обнаружения столкновений со стенами.

## Завершение сцены игрока
Добавьте узел Camera2D в сцену Player. Этот узел будет центрировать игровое окно на игроке по мере его перемещения по уровню. Вы также можете использовать его для увеличения изображения игрока, так как пиксель-арт относительно мал по сравнению с размером игрового окна. Помните, что, поскольку вы установили опцию фильтрации в Настройках проекта, текстура игрока останется пиксельной и блочной при увеличении масштаба.

Чтобы включить камеру, установите свойство Enabled в On, а затем установите Zoom в (2.5, 2.5). Значения меньше 1 уменьшают масштаб камеры, а большие значения увеличивают его.

Вы увидите розовато-пурпурный прямоугольник вокруг игрока. Это экранная область камеры и показывает, что увидит камера. Вы можете регулировать свойство Zoom, чтобы увеличивать или уменьшать ее размер и видеть больше или меньше мира вокруг игрока.

## Состояния игрока
У игрового персонажа есть разнообразное поведение, такое как прыжки, бег и приседания. Программирование таких поведений может стать очень сложным и трудным в управлении. Один из способов решения этой проблемы - использовать булевы переменные (например, is_jumping или is_running), но это может привести к возможно запутанным состояниям (что, если и is_crouching, и is_jumping одновременно true?) и быстро привести к _spaghetti_ коду.

Лучшим решением этой проблемы является использование конечного автомата для управления текущим состоянием игрока и управления переходом к другим состояниям. Этот концепт был представлен в главе 3, и вы будете расширять его в этом проекте.

![Вот диаграмма состояний игрока](/img/jungle-jump/B19289_04_09.jpg)

Как видно, диаграммы состояний могут стать достаточно сложными, даже с относительно небольшим количеством состояний.

## Другие состояния

Обратите внимание, что, хотя в спрайт-листе содержатся анимации для них, состояния CROUCH и CLIMB здесь не включены. Это сделано для упрощения управления количеством состояний в начале проекта. Позднее у вас будет возможность добавить их.