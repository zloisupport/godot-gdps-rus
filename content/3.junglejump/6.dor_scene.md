
# Сцена двери
Создайте новую сцену с узлом Area2D и именем Door, сохраните ее в папке items. Добавьте узел Sprite2D и используйте изображение props.png в качестве текстуры. В разделе Region нажмите Enabled, а затем кнопку Edit Region, чтобы выбрать изображение двери из спрайт-листа. Затем в Offset/Offset установите y в -8. Это обеспечит правильное положение двери при размещении ее в месте тайла.

Добавьте узел CollisionShape2D и дайте ему прямоугольную форму, которая охватывает дверь. Поместите дверь на слой items и установите ее маску так, чтобы она сканировала только слой игрока.

Для этой сцены не нужен сценарий, потому что вы собираетесь использовать ее сигнал body_entered в сценарии уровня.

Чтобы разместить дверь в уровне, вы можете использовать объект door из тайлсета tiles_items, который вы используете в своей карты тайлов Items для размещения вишен и драгоценных камней. Разместите дверь в вашем уровне и откройте level.gd.

В начале level.gd определите сцену двери:
```gdscript
var door_scene = load("res://items/door.tscn")
```
Затем обновите функцию spawn_items(), чтобы она также создавала двери:

```gdscript
func spawn_items():
    var item_cells = $Items.get_used_cells(0)
    for cell in item_cells:
        var data = $Items.get_cell_tile_data(0, cell)
        var type = data.get_custom_data("type")
        if type == "door":
            var door = door_scene.instantiate()
            add_child(door)
            door.position = $Items.map_to_local(cell)
            door.body_entered.connect(_on_door_entered)
        else:
            var item = item_scene.instantiate()
            add_child(item)
            item.init(type, $Items.map_to_local(cell))
            item.picked_up.connect(self._on_item_picked_up)
```


Добавьте функцию, которая будет вызываться, когда игрок касается двери:

```gdscript
func _on_door_entered(body):
    GameState.next_level()
```

Запустите игру и попробуйте пройти в дверь. Если вы установили в game_state.gd переменную `num_levels` равной числу больше 1, игра попытается загрузить level_02.tscn, когда вы коснетесь двери.

# Настройки экрана
Напомним, что в начале этой главы вы установили режим растяжения (Stretch/Mode) и соотношение сторон (Aspect) в Настройках проекта на canvas_items и expand, соответственно. Запустите игру и попробуйте изменить размер окна игры. Обратите внимание, что, если вы расширите окно, вы сможете видеть больше мира игры слева/справа от игрока. Это то, что делает значение expand.

Если вы хотите предотвратить это, вы можете установить его в значение keep, которое всегда будет показывать одинаковое количество мира игры, что видно камерой. Однако это также означает, что если вы измените форму окна на что-то отличное от формы игры, появятся черные полосы, чтобы заполнить дополнительное пространство.

В качестве альтернативы, установка значения ignore не будет отображать черные полосы, но содержимое игры будет растянуто для заполнения пространства, и это может исказить изображение.

Потратьте некоторое время на эксперименты с различными настройками и решите, какие вам больше нравятся.
# Финишная прямая
Хотя вы завершили основную структуру игры и, вероятно, создали несколько уровней для игрока, можно рассмотреть возможность добавления некоторых элементов для улучшения геймплея. В этом разделе вы найдете еще несколько предложенных функций - добавьте их как есть или настройте под свой вкус.


# Звуковые эффекты
Как и в предыдущих проектах, вы можете добавить звуковые эффекты и музыку для улучшения опыта игры. В папке res://assets/audio/ вы найдете аудиофайлы, которые вы можете использовать для различных событий в игре, таких как прыжок игрока, удар по врагу и подбор предмета. Также есть два файлы музыки: Intro Theme для экрана заголовка и Grasslands Theme для сцены уровня.

Добавление их в игру остается за вами, но вот несколько советов:

- Вам может быть полезно настроить громкость отдельных звуков. Это можно сделать с помощью свойства Volume dB. Установка отрицательного значения уменьшит громкость звука.
- Вы можете присоединить музыку к сцене master level.tscn; эта музыка будет использоваться для всех уровней. Вы также можете присоединить отдельную музыку к индивидуальным уровням, если хотите создать определенное настроение.
- Ваше первое предположение, возможно, будет заключаться в том, чтобы разместить AudioStreamPlayer на сцене Item для воспроизведения звука подбора. Однако, поскольку предмет удаляется, когда игрок его касается, это не сработает хорошо. Вместо этого поместите аудиоплеер в сцену Level, так как именно там обрабатывается результат подбора (увеличение счета).


Двойные прыжки - популярная функция в платформерах. Игрок получает второй, обычно меньший, всплеск вверх, если они нажимают клавишу прыжка второй раз, находясь в воздухе. Для реализации этой функции вам нужно добавить несколько вещей в сценарий игрока.

В первую очередь, вам понадобятся переменные для отслеживания количества прыжков и определения того, насколько велик будет второй всплеск:

```gdscript
@export var max_jumps = 2
@export var double_jump_factor = 1.5
var jump_count = 0
```

При входе в состояние JUMP сбросьте количество прыжков:

```gdscript
JUMP:
    $AnimationPlayer.play("jump_up")
    jump_count = 1
```

В функции get_input() разрешите прыжок, если выполнены определенные условия. Разместите это перед оператором if, где вы проверяете, находится ли игрок на полу:

```gdscript
if jump and state == JUMP and jump_count < max_jumps and jump_count > 0:
    $JumpSound.play()
    $AnimationPlayer.play("jump_up")
    velocity.y = jump_speed / double_jump_factor
    jump_count += 1
```

В _physics_process(), когда вы приземляетесь на землю, сбросьте количество прыжков:

```gdscript
if state == JUMP and is_on_floor():
    change_state(IDLE)
    jump_count = 0
```

Запустите вашу игру и попробуйте двойные прыжки. Обратите внимание, что этот код делает второй прыжок 2/3 от высоты вверх от начального прыжка. Вы можете настроить это в соответствии с вашими предпочтениями.


**Частицы пыли**

Создание эффекта вылетающих частиц пыли у ног персонажа - это простой, но заметный прием, который может добавить характера движениям вашего игрока. В этом разделе вы добавите небольшое облако пыли к ногам игрока, которое появляется каждый раз, когда они приземляются на землю. Это придаст ощущение веса и удара прыжкам игрока.

Добавьте узел CPUParticles2D к сцене Player и назовите его Dust. Установите следующие свойства:

**Свойство** | **Значение**
--- | ---
**Amount** | 20
**Lifetime** | 0.45
**One Shot** | On
**Speed Scale** | 2
**Explosiveness** | 0.7
**Emission Shape** | Rectangle
**Rect Extents** | 1, 6
**Initial Velocity Max** | 10
**Scale Amount Max** | 3
**Position** | -2, 0
**Rotation** | -90

Цвет частиц по умолчанию - белый, но эффект пыли будет выглядеть лучше в бежевом оттенке. Он также должен исчезнуть, чтобы казаться рассеивающимся. Это можно сделать с помощью Gradient. В разделе Color/Color Ramp выберите New Gradient.

Gradient имеет два цвета: начальный цвет слева и конечный цвет справа. Их можно выбрать, используя маленькие прямоугольники на обоих концах градиента. Нажав на большой квадрат справа, вы можете установить цвет для выбранного прямоугольника:

![Градиент](/img/jungle-jump/B19289_04_27.jpg)

Установите начальный цвет в бежевый оттенок и установите для конечного того же цвета, но с установленным значением альфа-канала равным 0. Вы должны увидеть непрерывный эффект дыма. В инспекторе установите One Shot в положение on. Теперь частицы будут испускаться только один раз, каждый раз, когда вы устанавливаете флажок Emitting.

Не стесняйтесь изменять предоставленные здесь свойства. Эксперименты с частицами могут быть увлекательными, и часто вы случайно обнаруживаете очень красивый эффект, просто поколдовав.

Когда вы будете удовлетворены его внешним видом, добавьте следующий код в _physics_process() игрока:

```gdscript
if state == JUMP and is_on_floor():
    change_state(IDLE)
    $Dust.emitting = true
```

Запустите игру и наблюдайте облако пыли каждый раз, когда ваш персонаж приземляется на землю.


# Лестницы

В анимационной карте спрайта игрока есть кадры для анимации взбирания, а в тайлсете есть изображения лестниц. В настоящее время тайлы лестниц ничего не делают - в TileSet для них не назначена форма столкновения. Это нормально, потому что вы не хотите, чтобы игрок сталкивался с лестницами - вы хотите, чтобы он мог двигаться вверх и вниз по ним.